---
import { getCollection, render } from "astro:content";
import type { MarkdownHeading } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const formattedDate = post.data.date.toLocaleDateString("zh-CN", {
  year: "numeric",
  month: "long",
  day: "numeric",
});
---

<BaseLayout title={`${post.data.title} - Blog`}>
  <div class="blog-layout">
    <!-- Main content -->
    <article class="blog-article">
      <header class="blog-article-header">
        <a href="/blog" class="blog-back-link">
          <i class="bi bi-arrow-left"></i> 返回博客列表
        </a>
        <h1 class="blog-article-title">{post.data.title}</h1>
        <div class="blog-article-meta">
          <time datetime={post.data.date.toISOString()}>
            <i class="bi bi-calendar3"></i> {formattedDate}
          </time>
          {
            post.data.tags && post.data.tags.length > 0 && (
              <div class="blog-article-tags">
                {post.data.tags.map((tag) => (
                  <span class="blog-tag">{tag}</span>
                ))}
              </div>
            )
          }
        </div>
        {
          post.data.description && (
            <p class="blog-article-desc">{post.data.description}</p>
          )
        }
      </header>

      <hr class="blog-divider" />

      <div class="markdown-body">
        <Content />
      </div>
    </article>

    <!-- TOC sidebar -->
    {headings && headings.length > 0 && (
      <aside class="blog-toc-sidebar">
        <div class="blog-toc-sticky">
          <div class="blog-toc-container">
            <div class="blog-toc-header">
              <h3 class="blog-toc-title">目录</h3>
              <button
                id="toc-toggle"
                class="blog-toc-toggle"
                aria-label="切换目录"
                type="button"
              >
                <i class="bi bi-chevron-up"></i>
              </button>
            </div>
            <nav id="toc-content" class="blog-toc-nav">
              {headings.map((heading: MarkdownHeading) => {
                const level = heading.depth;
                const paddingLeft = Math.max(0, (level - 1) * 12);
                return (
                  <a
                    href={`#${heading.slug}`}
                    class="toc-item"
                    style={{ "--toc-level": `${paddingLeft}px` }}
                    title={heading.text}
                  >
                    {heading.text}
                  </a>
                );
              })}
            </nav>
          </div>
        </div>
      </aside>
    )}
  </div>
</BaseLayout>

<!-- Client-side: code blocks (copy button + lang icon) + external links + TOC -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Wrap code blocks with header (language icon + copy button)
    document.querySelectorAll(".markdown-body pre").forEach((pre) => {
      if (pre.closest(".blog-code-block")) return;

      const code = pre.querySelector("code");
      const lang =
        (code?.className || "").replace(/language-/, "") ||
        code?.getAttribute("data-language") ||
        "plaintext";

      const wrapper = document.createElement("div");
      wrapper.className = "blog-code-block";

      const header = document.createElement("div");
      header.className = "blog-code-header";

      const label = document.createElement("div");
      label.className = "blog-code-label";

      const mapping: Record<string, string> = {
        typescript: "typescript",
        javascript: "javascript",
        python: "python",
        java: "java",
        csharp: "csharp",
        cpp: "cplusplus",
        c: "c",
        go: "go",
        rust: "rust",
        php: "php",
        ruby: "ruby",
        swift: "swift",
        html: "html5",
        css: "css3",
        json: "json",
        bash: "bash",
        shell: "bash",
        tsx: "typescript",
        jsx: "javascript",
      };
      const iconName = mapping[lang.toLowerCase().trim()];
      if (iconName) {
        const img = document.createElement("img");
        img.src = `https://cdn.jsdelivr.net/gh/devicons/devicon@2.17.0/icons/${iconName}/${iconName}-original.svg`;
        img.alt = lang;
        img.className = "blog-code-icon";
        img.loading = "lazy";
        label.appendChild(img);
      }

      const langSpan = document.createElement("span");
      langSpan.className = "blog-code-language";
      langSpan.textContent = lang;
      label.appendChild(langSpan);

      const copyBtn = document.createElement("button");
      copyBtn.className = "blog-code-copy";
      copyBtn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg><span>Copy</span>`;
      copyBtn.addEventListener("click", async () => {
        const text = pre.textContent ?? "";
        try {
          await navigator.clipboard.writeText(text);
          copyBtn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/></svg><span>Copied!</span>`;
          setTimeout(() => {
            copyBtn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"/></svg><span>Copy</span>`;
          }, 2000);
        } catch {
          /* noop */
        }
      });

      header.appendChild(label);
      header.appendChild(copyBtn);

      pre.parentNode!.insertBefore(wrapper, pre);
      wrapper.appendChild(header);
      wrapper.appendChild(pre);
    });

    // External links open in new tab
    document
      .querySelectorAll(".markdown-body a[href^='http']")
      .forEach((a) => {
        a.setAttribute("target", "_blank");
        a.setAttribute("rel", "noopener noreferrer");
      });

    // Lazy load images
    document.querySelectorAll(".markdown-body img").forEach((img) => {
      img.setAttribute("loading", "lazy");
    });

    // TOC toggle (mobile)
    const tocToggle = document.getElementById("toc-toggle");
    const tocContent = document.getElementById("toc-content");

    if (tocToggle && tocContent) {
      tocToggle.addEventListener("click", () => {
        tocContent.classList.toggle("expanded");
        const icon = tocToggle.querySelector("i");
        if (icon) {
          icon.className = tocContent.classList.contains("expanded")
            ? "bi bi-chevron-down"
            : "bi bi-chevron-up";
        }
      });
    }

    // TOC smooth scroll
    document.querySelectorAll(".toc-item").forEach((item) => {
      item.addEventListener("click", (e) => {
        e.preventDefault();
        const href = (item as HTMLAnchorElement).getAttribute("href");
        if (!href || !href.startsWith("#")) return;

        const id = href.slice(1);
        const el = document.getElementById(id);
        if (!el) return;

        const top = el.getBoundingClientRect().top + window.scrollY - 100;
        window.scrollTo({ top, behavior: "smooth" });

        // Close TOC on mobile
        if (window.innerWidth < 1024 && tocContent) {
          tocContent.classList.remove("expanded");
          const icon = tocToggle?.querySelector("i");
          if (icon) icon.className = "bi bi-chevron-up";
        }
      });
    });
  });
</script>

<style is:global>
  /* ══════════════════════════════════════════════════════════
     Blog Layout — Inspired by ani-website Doc.astro
     ══════════════════════════════════════════════════════════ */

  :root {
    --gh-bg: #0d1117;
    --gh-bg-secondary: #161b22;
    --gh-bg-tertiary: #21262d;
    --gh-fg: #e6edf3;
    --gh-fg-muted: #848d97;
    --gh-fg-subtle: #6e7681;
    --gh-border: #30363d;
    --gh-border-muted: #21262d;
    --gh-link: #2f81f7;
    --gh-link-hover: #58a6ff;
    --gh-accent: #1f6feb;
    --gh-code-bg: rgba(110, 118, 129, 0.4);
    --gh-code-block-bg: #161b22;
    --gh-font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans",
      Helvetica, Arial, sans-serif;
    --gh-font-mono: ui-monospace, "SFMono-Regular", "SF Mono", Menlo, Consolas,
      monospace;
    --gh-note: #2f81f7;
    --gh-tip: #3fb950;
    --gh-important: #a371f7;
    --gh-warning: #d29922;
    --gh-caution: #f85149;
  }

  /* ── Two-column layout ── */
  .blog-layout {
    display: flex;
    gap: 24px;
    min-width: 0;
    animation: slideUp 300ms cubic-bezier(0, 0, 0, 1) both;
  }

  .blog-article {
    flex: 1;
    min-width: 0;
    max-width: 100%;
  }

  /* ── Back link ── */
  .blog-back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--gh-fg-muted);
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    padding: 4px 0;
    margin-bottom: 16px;
    transition: color 150ms ease;
  }
  .blog-back-link:hover {
    color: var(--gh-link);
  }

  /* ── Article header ── */
  .blog-article-header {
    margin-bottom: 4px;
  }
  .blog-article-title {
    margin: 0 0 12px 0;
    font-size: 32px;
    font-weight: 600;
    line-height: 1.25;
    color: var(--gh-fg);
  }
  .blog-article-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    color: var(--gh-fg-muted);
  }
  .blog-article-meta time {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  .blog-article-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .blog-tag {
    display: inline-block;
    padding: 2px 10px;
    font-size: 12px;
    font-weight: 500;
    color: var(--gh-link);
    background: rgba(47, 129, 247, 0.1);
    border: 1px solid rgba(47, 129, 247, 0.2);
    border-radius: 12px;
    line-height: 1.6;
  }
  .blog-article-desc {
    margin: 12px 0 0 0;
    font-size: 16px;
    line-height: 1.5;
    color: var(--gh-fg-muted);
    font-style: italic;
  }

  .blog-divider {
    border: none;
    border-top: 1px solid var(--gh-border);
    margin: 16px 0 24px 0;
  }

  /* ── TOC Sidebar ── */
  .blog-toc-sidebar {
    width: 220px;
    flex-shrink: 0;
  }

  .blog-toc-sticky {
    position: sticky;
    top: 24px;
  }

  .blog-toc-container {
    background: var(--colorNeutralBackground3, #282828);
    border: 1px solid var(--colorNeutralStroke2, #333);
    border-radius: var(--borderRadiusLarge, 8px);
    padding: 16px;
    max-height: calc(100vh - 48px);
    overflow-y: auto;
  }

  .blog-toc-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--colorNeutralStroke2, #333);
  }

  .blog-toc-title {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--gh-fg);
  }

  .blog-toc-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--gh-fg-muted);
    cursor: pointer;
    padding: 2px;
    font-size: 14px;
  }

  .blog-toc-nav {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .toc-item {
    display: block;
    color: var(--gh-fg-muted);
    font-size: 13px;
    line-height: 1.4;
    border-radius: 4px;
    transition: color 150ms ease, background-color 150ms ease;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    text-decoration: none;
    padding: 4px 8px;
    padding-left: calc(8px + var(--toc-level, 0px));
  }

  .toc-item:hover {
    color: var(--gh-link) !important;
    background-color: rgba(255, 255, 255, 0.06);
    text-decoration: none;
  }

  /* ── Code Block Container ── */
  .blog-code-block {
    position: relative;
    margin-bottom: 16px;
    background-color: var(--gh-code-block-bg);
    border: 1px solid var(--gh-border);
    border-radius: 8px;
    overflow: hidden;
  }
  .blog-code-block pre {
    margin: 0;
    border: 0;
    border-radius: 0;
    background: transparent;
    padding: 14px 16px;
  }
  .blog-code-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: linear-gradient(
      180deg,
      var(--gh-bg-secondary) 0%,
      rgba(22, 27, 34, 0.5) 100%
    );
    border-bottom: 1px solid var(--gh-border);
    min-height: 40px;
    gap: 12px;
  }
  .blog-code-label {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .blog-code-icon {
    width: 16px;
    height: 16px;
    opacity: 0.9;
  }
  .blog-code-language {
    font-family: var(--gh-font-mono);
    font-size: 11px;
    font-weight: 600;
    color: var(--gh-fg-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .blog-code-copy {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    height: 26px;
    padding: 0 10px;
    background: transparent;
    border: 1px solid var(--gh-border);
    border-radius: 4px;
    color: var(--gh-fg-muted);
    font-size: 11px;
    font-family: var(--gh-font-body);
    font-weight: 500;
    cursor: pointer;
    transition: all 150ms ease;
  }
  .blog-code-copy:hover {
    background: var(--gh-border);
    color: var(--gh-fg);
  }

  /* ── Responsive ── */
  @media (max-width: 1024px) {
    .blog-toc-sidebar {
      position: fixed;
      bottom: 16px;
      right: 16px;
      width: auto;
      max-width: 280px;
      z-index: 100;
    }

    .blog-toc-sticky {
      position: static;
    }

    .blog-toc-container {
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    .blog-toc-toggle {
      display: block;
    }

    .blog-toc-nav:not(.expanded) {
      display: none;
    }

    .blog-toc-nav.expanded {
      display: flex;
    }

    .blog-toc-header {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .blog-toc-nav.expanded ~ .blog-toc-header,
    .blog-toc-header:has(~ .blog-toc-nav.expanded) {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--colorNeutralStroke2, #333);
    }
  }

  @media (max-width: 820px) {
    .blog-article-title {
      font-size: 28px;
    }
    .blog-code-header {
      padding: 8px 12px;
      min-height: 36px;
      gap: 8px;
    }
    .blog-code-language {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .blog-article-title {
      font-size: 22px;
    }
    .blog-back-link {
      font-size: 13px;
    }
    .markdown-body pre {
      padding: 10px 12px;
    }
  }
</style>

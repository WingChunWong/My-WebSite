name: Update Homework Data

on:
  schedule:
    - cron: "0 9 * * *" # æ¯å¤©UTC 09:00ï¼ˆé¦™æ¸¯æ—¶é—´17:00ï¼‰è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_full_update:
        description: "å¼·åˆ¶å®Œæ•´æ›´æ–°ï¼ˆå¿½ç•¥å¢žé‡æ›´æ–°é‚è¼¯ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "hw-list/requirements.txt"

      - name: Install Dependencies
        working-directory: hw-list
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Run Crawler
        id: crawler
        working-directory: hw-list
        env:
          PORTAL_USERNAME: ${{ secrets.PORTAL_USERNAME }}
          PORTAL_PASSWORD: ${{ secrets.PORTAL_PASSWORD }}
          FORCE_FULL_UPDATE: ${{ github.event.inputs.force_full_update == 'true' && 'true' || 'false' }}
        run: |
          # æª¢æŸ¥çˆ¬èŸ²è…³æœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "homework_crawler.py" ]; then
            echo "âŒ æœªæ‰¾åˆ°homework_crawler.py"
            echo "data_updated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # æ ¹æ“šç’°å¢ƒè®Šæ•¸é¸æ“‡æ›´æ–°æ¨¡å¼
          if [ "$FORCE_FULL_UPDATE" = "true" ]; then
            echo "ðŸš€ åŸ·è¡Œå¼·åˆ¶å®Œæ•´æ›´æ–° (FORCE_FULL_UPDATE=true)"
          else
            echo "ðŸ“… åŸ·è¡Œæ—¥å¸¸å¢žé‡æ›´æ–° (FORCE_FULL_UPDATE=false)"
          fi

          # é‹è¡Œçˆ¬èŸ²è…³æœ¬
          echo "â–¶ï¸ é‹è¡Œçˆ¬èŸ²è…³æœ¬..."
          python homework_crawler.py

          # é©—è­‰è³‡æ–™æ–‡ä»¶
          if [ -f "homework_data.json" ]; then
            # æª¢æŸ¥JSONæ ¼å¼æœ‰æ•ˆæ€§
            if python -c "import json; json.load(open('homework_data.json'))" 2>/dev/null; then
              RECORD_COUNT=$(python -c "import json; print(len(json.load(open('homework_data.json'))))")
              echo "data_updated=true" >> $GITHUB_OUTPUT
              echo "record_count=$RECORD_COUNT" >> $GITHUB_OUTPUT
              echo "âœ… æ•¸æ“šæ–‡ä»¶é©—è­‰é€šéŽï¼Œå…±$RECORD_COUNTæ¢è¨˜éŒ„"
            else
              echo "âŒ homework_data.jsonæ ¼å¼éŒ¯èª¤"
              echo "data_updated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ æœªç”Ÿæˆhomework_data.json"
            echo "data_updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Last_Update Data
        if: steps.crawler.outputs.data_updated == 'true'
        working-directory: hw-list
        run: |
          cat > last_update.json << EOF
          {
            "last_updated": "$(date -Iseconds)",
            "run_id": "${{ github.run_id }}",
            "trigger": "${{ github.event_name }}",
            "records": ${{ steps.crawler.outputs.record_count }}
          }
          EOF
          echo "âœ… å·²æ›´æ–°æœ€å¾Œæ›´æ–°æ•¸æ“šæ–‡ä»¶"

      - name: Configure Git
        if: steps.crawler.outputs.data_updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: git-check
        if: steps.crawler.outputs.data_updated == 'true'
        run: |
          git add hw-list/homework_data.json hw-list/last_update.json
          # æª¢æŸ¥æ˜¯å¦æœ‰å¯¦éš›è®Šæ›´ï¼ˆæŽ’é™¤ç©ºæäº¤ï¼‰
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç„¡è³‡æ–™è®Šæ›´ï¼Œç„¡éœ€æäº¤"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æª¢æ¸¬åˆ°è³‡æ–™è®Šæ›´ï¼Œæº–å‚™æäº¤"
          fi

      - name: Commit Changes
        if: steps.git-check.outputs.has_changes == 'true'
        run: |
          COMMIT_MSG="ðŸ“š è‡ªå‹•æ›´æ–°å®¶èª²æ•¸æ“šï¼ˆ${{ steps.crawler.outputs.record_count }}æ¢ï¼‰- $(date +"%Y-%m-%d")"
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create Summary
        if: always()
        run: |
          {
            echo "# ðŸ“Š å®¶èª²è³‡æ–™æ›´æ–°å ±å‘Š"
            echo ""
            echo "â±ï¸ **åŸ·è¡Œæ™‚é–“ï¼š** $(date)"
            echo ""
            
            echo "## ðŸ§­ æ›´æ–°æ¨¡å¼"
            if [ "${{ github.event.inputs.force_full_update }}" = "true" ]; then
              echo "- ðŸš€ **å¼·åˆ¶å®Œæ•´æ›´æ–°** (FORCE_FULL_UPDATE=true)"
            else
              echo "- ðŸ“… **æ—¥å¸¸å¢žé‡æ›´æ–°** (FORCE_FULL_UPDATE=false)"
            fi
            echo ""
            
            echo "## ðŸ“¦ æ›´æ–°çµæžœ"
            if [ "${{ steps.crawler.outputs.data_updated }}" = "true" ]; then
              echo "### âœ… è³‡æ–™æ›´æ–°æˆåŠŸ"
              echo ""
              echo "| é …ç›® | æ•¸å€¼ |"
              echo "|------|------|"
              echo "| ðŸ—‚ï¸ è³‡æ–™ç­†æ•¸ | **${{ steps.crawler.outputs.record_count }} ç­†** |"
              echo "| ðŸ”„ è§¸ç™¼æ–¹å¼ | \`${{ github.event_name }}\` |"
              
              if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                echo "| ðŸ‘¤ æ‰‹å‹•è§¸ç™¼è€… | \`${{ github.actor }}\` |"
              fi
              
              if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
                echo "| ðŸš€ éƒ¨ç½²ç‹€æ…‹ | **å·²è‡ªå‹•æäº¤æ›´æ–°** |"
              else
                echo "| â„¹ï¸ éƒ¨ç½²ç‹€æ…‹ | ç„¡è³‡æ–™è®Šæ›´ï¼Œæœªé€²è¡Œæäº¤ |"
              fi
              
            else
              echo "### âŒ è³‡æ–™æ›´æ–°å¤±æ•—"
              echo ""
              echo "> âš ï¸ è«‹æª¢æŸ¥ï¼š"
              echo "> 1. GitHub Secrets ä¸­çš„ PORTAL_USERNAME å’Œ PORTAL_PASSWORD æ˜¯å¦è¨­å®šæ­£ç¢º"
              echo "> 2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸"
              echo "> 3. å­¸æ ¡é–€æˆ¶ç¶²ç«™æ˜¯å¦å¯æ­£å¸¸è¨ªå•"
            fi
            
          } >> $GITHUB_STEP_SUMMARY
name: æ›´æ–°è³‡æ–™

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: å–å¾—åŸå§‹ç¢¼
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: å®‰è£ Pythonï¼ˆå«å¿«å–ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "tools/my-hw-list/requirements.txt"

      - name: å®‰è£å¥—ä»¶
        working-directory: tools/my-hw-list
        run: pip install -r requirements.txt

      - name: åŸ·è¡Œæ›´æ–°è…³æœ¬
        working-directory: tools/my-hw-list
        env:
          PORTAL_USERNAME: ${{ secrets.PORTAL_USERNAME }}
          PORTAL_PASSWORD: ${{ secrets.PORTAL_PASSWORD }}
        run: python homework_crawler.py

      # --- Summary ç¾åŒ– ---
      - name: ç”¢ç”Ÿæ›´æ–°æ‘˜è¦ï¼ˆSummaryï¼‰
        working-directory: tools/my-hw-list
        run: |
          echo "## ğŸ”„ è³‡æ–™æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### â° æœ€å¾Œæ›´æ–°æ™‚é–“" >> $GITHUB_STEP_SUMMARY
          cat last_update.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ“Š ä½œæ¥­çµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY

          python3 - << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("homework_data.json") as f:
              data = json.load(f)
          
          print("| é …ç›® | æ•¸é‡ |")
          print("| ---- | ---- |")
          print(f"| ä½œæ¥­ç¸½æ•¸ | {len(data)} |")
          EOF

      # --- Commit è‹¥æœ‰è®Šæ›´æ‰é€²è¡Œ ---
      - name: æäº¤æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tools/my-hw-list/homework_data.json
          git add tools/my-hw-list/last_update.json

          if git diff --cached --quiet; then
            echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤ï¼Œç•¥é commitã€‚"
            exit 0
          fi

          git commit -m "è‡ªå‹•æ›´æ–°è³‡æ–™"
          git push

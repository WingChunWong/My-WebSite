name: Update Homework Data

on:
  schedule:
    - cron: '0 9 * * *' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "hw-list/requirements.txt" 

      - name: Install dependencies
        working-directory: hw-list
        run: pip install -r requirements.txt

      - name: Run update script
        working-directory: hw-list 
        env:
          PORTAL_USERNAME: ${{ secrets.PORTAL_USERNAME }}
          PORTAL_PASSWORD: ${{ secrets.PORTAL_PASSWORD }}
        run: python homework_crawler.py

      # --- Summary ç¾åŒ– ---
      - name: Generate update summary (Summary)
        if: always()
        run: |
          {
            echo "# ğŸ“Š å®¶èª²è³‡æ–™æ›´æ–°å ±å‘Š"
            echo ""
            echo "â±ï¸ **åŸ·è¡Œæ™‚é–“ï¼š** $(date)"
            echo ""
            
            echo "## ğŸ§­ æ›´æ–°æ¨¡å¼"
            if [ "${{ github.event.inputs.force_full_update }}" = "true" ]; then
              echo "- ğŸš€ **å¼·åˆ¶å®Œæ•´æ›´æ–°**"
            else
              echo "- ğŸ“… **æ—¥å¸¸å¢é‡æ›´æ–°**"
            fi
            echo ""
            
            echo "## ğŸ“¦ æ›´æ–°çµæœ"
            if [ "${{ steps.crawler.outputs.data_updated }}" = "true" ]; then
              echo "### âœ… è³‡æ–™æ›´æ–°æˆåŠŸ"
              echo ""
              echo "| é …ç›® | æ•¸å€¼ |"
              echo "|------|------|"
              echo "| ğŸ—‚ï¸ è³‡æ–™ç­†æ•¸ | **${{ steps.crawler.outputs.record_count }} ç­†** |"
              echo "| ğŸ”„ è§¸ç™¼æ–¹å¼ | \`${{ github.event_name }}\` |"
              
              if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                echo "| ğŸ‘¤ æ‰‹å‹•è§¸ç™¼è€… | \`${{ github.actor }}\` |"
              fi
              
              if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
                echo "| ğŸš€ éƒ¨ç½²ç‹€æ…‹ | **å·²è‡ªå‹•è§¸ç™¼éƒ¨ç½²** |"
              else
                echo "| â„¹ï¸ éƒ¨ç½²ç‹€æ…‹ | ç„¡è³‡æ–™è®Šæ›´ï¼Œæœªé€²è¡Œéƒ¨ç½² |"
              fi
              
            else
              echo "### âŒ è³‡æ–™æ›´æ–°å¤±æ•—"
              echo ""
              echo "> âš ï¸ è«‹æª¢æŸ¥ï¼šGitHub Secretsã€ç¶²è·¯é€£ç·šã€ç™»å…¥è³‡è¨Šæ˜¯å¦è¨­å®šæ­£ç¢º"
            fi
            
          } >> $GITHUB_STEP_SUMMARY


      # --- Commit è‹¥æœ‰è®Šæ›´æ‰é€²è¡Œ ---
      - name: Commit updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hw-list/homework_data.json 
          git add hw-list/last_update.json    
          if git diff --cached --quiet; then
            echo "âš ï¸ ç„¡è®Šæ›´å¯æäº¤ï¼Œç•¥é commitã€‚"
            exit 0
          fi

          git commit -m "åœ¨ $(date +"%Y-%m-%d %H:%M:%S") è‡ªå‹•æ›´æ–°å®¶èª²è³‡æ–™ ğŸ“š"
          git push